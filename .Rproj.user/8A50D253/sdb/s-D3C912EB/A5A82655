{
    "contents" : "# Clear memory from previous runs\nbase::rm(list=base::ls(all=TRUE))\n\n\n## @knitr LoadPackages\n# Load the necessary packages.\nbase::require(base)\nbase::require(knitr)\nbase::require(markdown)\nbase::require(testit)\nbase::require(plyr)\nbase::require(reshape2)\nbase::require(stringr)\n\n\n## @knitr DeclareGlobals\n\n\n\n## @knitr LoadData\n\n# Links to the data source # for now keep the link non-dynamic\npathDataSource <- \"./Data/Extract/NLSY97_Religiosity_20140420/NLSY97_Religiosity_20140420.csv\"\nds0<-read.csv(pathDataSource,header=TRUE, skip=0,sep=\",\")\n\n\n## @knitr QueryData\nds0$T6650500<-NULL # Remove \"Version number\"  for cleaner dataset\n\n\n## @knitr ImportVarLabels\n### NLSY97 variable id are linked to the descriptive label in the file dictionary file \"NLSY97_Religiosity_20140420.dtc\" ###\npathDataSource <- \"./Data/Extract/NLSY97_Religiosity_20140420/NLSY97_Religiosity_20140420.dct\"\nds0Labels<-read.csv(pathDataSourceLabels,header=TRUE, skip=0,nrow=135, sep=\"\")\nds0Labels$X.<-NULL\n# rename to match NLS Web Investigator format\nds0Labels<-rename(ds0Labels,replace=c(\"infile\"=\"RNUM\",\"dictionary\"=\"VARIABLE_TITLE\")) \n# remove \"Version number\" from list of variables\nds0Labels<-ds0Labels[ds0Labels$RNUM!=\"T6650500\",] \nds0Labels<-arrange(ds0Labels,VARIABLE_TITLE) # sort by Variable Title\nwrite.table(ds0Labels, \"./Data/ItemMapping/ds0Labels.csv\", sep=\",\")\n\n## @knitr RenameVariables\nds0<-rename(ds0, c(\n  \"R0323900\"=\"famrel_1997\",\n  \"R2165200\"=\"famrel_1998\",\n  \"R3483100\"=\"famrel_1999\",\n  \"R4881300\"=\"famrel_2000\",\n  \"S2977900\"=\"internet_2003\",\n  \"S4676700\"=\"internet_2004\",\n  \"S6308900\"=\"internet_2005\",\n  \"S8329800\"=\"internet_2006\",\n  \"T0737600\"=\"internet_2007\",\n  \"T2779700\"=\"internet_2008\",\n  \"T4494400\"=\"internet_2009\",\n  \"T6141400\"=\"internet_2010\",\n  \"T7635300\"=\"internet_2011\",\n  \"R1193900\"=\"agemon_1997\",\n  \"R2553400\"=\"agemon_1998\",\n  \"R3876200\"=\"agemon_1999\",\n  \"R5453600\"=\"agemon_2000\",\n  \"R7215900\"=\"agemon_2001\",\n  \"S1531300\"=\"agemon_2002\",\n  \"S2000900\"=\"agemon_2003\",\n  \"S3801000\"=\"agemon_2004\",\n  \"S5400900\"=\"agemon_2005\",\n  \"S7501100\"=\"agemon_2006\",\n  \"T0008400\"=\"agemon_2007\",\n  \"T2011000\"=\"agemon_2008\",\n  \"T3601400\"=\"agemon_2009\",\n  \"T5201300\"=\"agemon_2010\",\n  \"T6651200\"=\"agemon_2011\",\n  \"R1194100\"=\"ageyear_1997\",\n  \"R2553500\"=\"ageyear_1998\",\n  \"R3876300\"=\"ageyear_1999\",\n  \"R5453700\"=\"ageyear_2000\",\n  \"R7216000\"=\"ageyear_2001\",\n  \"S1531400\"=\"ageyear_2002\",\n  \"S2001000\"=\"ageyear_2003\",\n  \"S3801100\"=\"ageyear_2004\",\n  \"S5401000\"=\"ageyear_2005\",\n  \"S7501200\"=\"ageyear_2006\",\n  \"T0008500\"=\"ageyear_2007\",\n  \"T2011100\"=\"ageyear_2008\",\n  \"T3601500\"=\"ageyear_2009\",\n  \"T5201400\"=\"ageyear_2010\",\n  \"T6651300\"=\"ageyear_2011\",\n  \"R1235800\"=\"sample\",\n  \"S0919700\"=\"todo_2002\",\n  \"S6317100\"=\"todo_2005\",\n  \"T2782200\"=\"todo_2008\",\n  \"T7637800\"=\"todo_2011\",\n  \"R4893900\"=\"happy_2000\",\n  \"S0921100\"=\"happy_2002\",\n  \"S4682200\"=\"happy_2004\",\n  \"S8332600\"=\"happy_2006\",\n  \"T2782900\"=\"happy_2008\",\n  \"T6144000\"=\"happy_2010\",\n  \"R4893600\"=\"nervous_2000\",\n  \"S0920800\"=\"nervous_2002\",\n  \"S4681900\"=\"nervous_2004\",\n  \"S8332300\"=\"nervous_2006\",\n  \"T2782600\"=\"nervous_2008\",\n  \"T6143700\"=\"nervous_2010\",\n  \"R4893700\"=\"calm_2000\",\n  \"S0920900\"=\"calm_2002\",\n  \"S4682000\"=\"calm_2004\",\n  \"S8332400\"=\"calm_2006\",\n  \"T2782700\"=\"calm_2008\",\n  \"T6143800\"=\"calm_2010\",\n  \"R4894000\"=\"depressed_2000\",\n  \"S0921200\"=\"depressed_2002\",\n  \"S4682300\"=\"depressed_2004\",\n  \"S8332700\"=\"depressed_2006\",\n  \"T2783000\"=\"depressed_2008\",\n  \"T6144100\"=\"depressed_2010\",\n  \"R4893800\"=\"blue_2000\",\n  \"S0921000\"=\"blue_2002\",\n  \"S4682100\"=\"blue_2004\",\n  \"S8332500\"=\"blue_2006\",\n  \"T2782800\"=\"blue_2008\",\n  \"T6143900\"=\"blue_2010\",\n  \"R0552400\"=\"attendPR\",\n  \"R4893400\"=\"attend_2000\",\n  \"R6520100\"=\"attend_2001\",\n  \"S0919300\"=\"attend_2002\",\n  \"S2987800\"=\"attend_2003\",\n  \"S4681700\"=\"attend_2004\",\n  \"S6316700\"=\"attend_2005\",\n  \"S8331500\"=\"attend_2006\",\n  \"T0739400\"=\"attend_2007\",\n  \"T2781700\"=\"attend_2008\",\n  \"T4495000\"=\"attend_2009\",\n  \"T6143400\"=\"attend_2010\",\n  \"T7637300\"=\"attend_2011\",\n  \"S1225400\"=\"computer_2002\",\n  \"T1049900\"=\"computer_2007\",\n  \"T3145100\"=\"computer_2008\",\n  \"T4565400\"=\"computer_2009\",\n  \"T6209600\"=\"computer_2010\",\n  \"T7707000\"=\"computer_2011\",\n  \"S1225500\"=\"tv_2002\",\n  \"T1050000\"=\"tv_2007\",\n  \"T3145200\"=\"tv_2008\",\n  \"T4565500\"=\"tv_2009\",\n  \"T6209700\"=\"tv_2010\",\n  \"T7707100\"=\"faith_2011\",\n  \"T2782400\"=\"faith_2008\",\n  \"T7638000\"=\"bmonth\",\n  \"R0536401\"=\"bmonth\",\n  \"R0536402\"=\"byear\",\n  \"R1482600\"=\"race\",\n  \"R0536300\"=\"sex\",\n  \"R0000100\"=\"id\",\n  \"T2111500\"=\"bornagain_2008\",\n  \"T6759400\"=\"bornagain_2011\",\n  \"S0919600\"=\"decisions_2002\",\n  \"S6317000\"=\"decisions_2005\",\n  \"T2782100\"=\"decisions_2008\",\n  \"T7637700\"=\"decisions_2011\",\n  \"S0919500\"=\"obeyed_2002\",\n  \"S6316900\"=\"obeyed_2005\",\n  \"T2782000\"=\"obeyed_2008\",\n  \"T7637600\"=\"obeyed_2011\",\n  \"S5532800\"=\"relpref_2005\",\n  \"T2111400\"=\"relpref_2008\",\n  \"T6759300\"=\"relpref_2011\",\n  \"S0919400\"=\"values_2002\",\n  \"S6316800\"=\"values_2005\",\n  \"T2781900\"=\"values_2008\",\n  \"T7637500\"=\"values_2011\",\n  \"S0919800\"=\"pray_2002\",\n  \"S6317200\"=\"pray_2005\",\n  \"T2782300\"=\"pray_2008\",\n  \"T7637900\"=\"pray_2011\",\n  \"R0552300\"=\"relprefPR\",\n  \"R0552200\"=\"relraisedPR\"\n  \n))\n\n## @knitr RecodeNegative\n# recode negativale worded question so that :  1 - more religious, 0 - less religious\nfor (item in c(\"todo\",\"values\")){\n  for (year in c(2002,2005,2008,2011)){\n    itemyear<-(paste0(item , \"_\" , year))\n    ds0[,itemyear]=ifelse( (ds0[,itemyear] %in% c(1)) , 0 ,ifelse((ds0[,itemyear] %in% c(0)),1,NA))\n  }\n}\n\n## @knitr RemoveIllegal \n# Remove illegal values. See codebook for description of missingness\nillegal<-as.integer(c(-5:-1,997,998,999))\nSourceVariables<-names(ds0)\n\nfor( variable in SourceVariables ){\n  ds0[,variable]=ifelse(ds0[,variable] %in% c(-5:-1),NA,ds0[,variable])\n  \n}\n\n# Include only records with a valid birth year\nds0 <- ds0[ds0$byear %in% 1980:1984, ]\n\n#Include only records with a valid ID\nds0 <- ds0[ds0$id != \"V\", ]\nds0$id <- as.integer(ds0$id)\ndsW <- ds0 # At this point the data is in the wide format ( relative to time)\n# remove all but one dataset\nrm(list=setdiff(ls(), c(\"ds0\",\"dsW\")))\n# note that at this pint ds0 = dsW\n\n\n\n## @knitr MakeLong\n# Variables, which values that DON'T change with time - time invariant (TI) variables \nTIvars<-c(\"sample\", \"id\", \"sex\",\"race\", \"bmonth\",\"byear\",  'attendPR', \"relprefPR\", \"relraisedPR\")\n## id.vars declares MEASURED variables (as opposed to RESPONSE variable)\ndsLong <- reshape2::melt(dsW, id.vars=TIvars)\n\n\n# head(dsLong[dsLong$id==1,],20)\n\ndplyr::filter(dsLong,id==1) %>% dplyr::select(dsLong,id,year,attend)\n# create varaible \"year\" by stripping the automatic ending in TV variables' names\ndsLong$year<-str_sub(dsLong$variable,-4,-1) \n# the automatic ending in TV variables' names\ntimepattern<-c(\"_1997\", \"_1998\", \"_1999\", \"_2000\", \"_2001\", \"_2002\", \"_2003\", \"_2004\", \"_2005\", \"_2006\",\"_2007\", \"_2008\", \"_2009\", \"_2010\", \"_2011\")\n# Strip off the automatic ending\nfor (i in timepattern){\n  dsLong$variable <- gsub(pattern=i, replacement=\"\", x=dsLong$variable) \n}\n# Convert to a number.\ndsLong$year <- as.integer(dsLong$year) \n\n\n# reorder for easier inspection\ndsLong<-dsLong[with(dsLong, order(id,variable)), ] # alternative sorting to plyr\n# view the long data for one person\n# print(dsLong[dsLong$id==1,]) \n\n##############################\n## Create individual long datasets, one per TV variable\n## NOTE: for development: loop over the dataset\n\n## Time invariant (TI) variables are :\n# print (TIvars)\n## Time variant (TV) variables are :\nTVvars<-unique(dsLong$variable)\n# TVvars<-c(\"attend\",\"tv\") # to test on a few variables\n# Create a long (L) dataset (ds) with time invariant (TI) variables \ndsLTI<-subset(dsLong,subset=(dsLong$variable==\"agemon\")) # agemon because it has 1997:2011\ndsLTI<-rename(dsLTI,replace=c(\"value\"=\"agemon\"))\ndsLTI<-dsLTI[c(TIvars,\"year\")] # select only TI variables\n\n## Strip off each  TV (Time Invariant covariate) from dsLong to merge later\nfor ( i in TVvars){\n  dstemp<-subset(dsLong,subset=(dsLong$variable==i))\n  dstemp<-rename(dstemp,replace=c(\"value\"=i))\n  dstemp<-dstemp[c(\"id\",\"year\",i)]\n  dsLTI<-merge(x=dsLTI,y=dstemp,by=c(\"id\",\"year\"),all.x=TRUE)\n}\n## Merging datasets\n# Outer join: merge(x = df1, y = df2, by = \"CustomerId\", all = TRUE)\n# Left outer: merge(x = df1, y = df2, by = \"CustomerId\", all.x=TRUE)\n# Right outer: merge(x = df1, y = df2, by = \"CustomerId\", all.y=TRUE)\n# Cross join: merge(x = df1, y = df2, by = NULL)\n\n# OPTIONAL. Order variables in dsL to match the order in \"NLSY97_Religiosity_20042012.xlsx\"\ndsL_order<-c(\"sample\"  ,\"id\"  ,\"sex\"\t,\"race\"\t,\"bmonth\"\t,\"byear\"\t,\"attendPR\"\t,\"relprefPR\"\t,\"relraisedPR\"\t,\"year\",\"agemon\"\t,\"ageyear\"\t,\"famrel\"\t,\"attend\"\t,\"values\"\t,\"todo\"\t,\"obeyed\"\t,\"pray\"\t,\"decisions\"\t,\"relpref\"\t,\"bornagain\"\t,\"faith\"\t,\"calm\"\t,\"blue\"\t,\"happy\"\t,\"depressed\"\t,\"nervous\"\t,\"tv\"\t,\"computer\"\t,\"internet\")\ndsL<-dsLTI[dsL_order]\n\n# NOTE: repsondent id=467 has an abberation in age data (agemon for 2000)\nprint ( dsL[dsL$id==467, c(\"id\",\"year\", \"byear\",\"bmonth\",\"agemon\", \"ageyear\")])\n# the observation for this subject is removed\ndsL <- dsL[!(dsL$id %in% c(467)), ]\n\n## @knitr LabelFactors\nsource(file.path(pathDir,\"Scripts/Data/LabelingFactorLevels.R\"))\n\n## @knitr SaveDerivedData\n\npathdsLcvs <- file.path(getwd(),\"Data/Derived/dsL.csv\")\nwrite.csv(dsL,pathdsLcvs,  row.names=FALSE)\n\npathdsLrds <- file.path(pathDir,\"Data/Derived/dsL.rds\")\nsaveRDS(object=dsL, file=pathdsLrds, compress=\"xz\")\n\n## @knitr CleanUp\n# # remove all but specified dataset\nrm(list=setdiff(ls(), c(\"TIvars\",\"TVvars\",\"dsL\")))\n",
    "created" : 1413566299265.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1713238440",
    "id" : "A5A82655",
    "lastKnownWriteTime" : 1413567007,
    "path" : "~/GitHub/COAG-colloquium-2014F/Scripts/Data/dsL.R",
    "project_path" : "Scripts/Data/dsL.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}